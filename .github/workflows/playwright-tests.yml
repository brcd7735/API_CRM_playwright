name: Playwright API Tests

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–∞—Ö –∏ PR –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # üîÅ 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout code
        uses: actions/checkout@v4

      # üü¶ 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js (–≤–µ—Ä—Å–∏—è –∏–∑ .nvmrc –∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–∞—è)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # üì¶ 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: npm ci

      # üß™ 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Playwright browsers (–¥–∞–∂–µ –¥–ª—è API –Ω—É–∂–Ω—ã –±—Ä–∞—É–∑–µ—Ä—ã, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Playwright)
      - name: Install Playwright browsers
        run: npx playwright install-deps  # –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        # –ï—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω UI, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: playwright install --no-deps

      # üîê 5. –ó–∞–≥—Ä—É–∑–∏—Ç—å .env —Ñ–∞–π–ª (API –∫–ª—é—á) –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub
      - name: Create .env file from secrets
        env:
          API_KEY: ${{ secrets.API_KEY }},
          USER_LOGIN: ${{ secrets.USER_LOGIN }},
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }},
          OPEN_API_URL: ${{ secrets.OPEN_API_URL }},
          URL_CRM: ${{ secrets.URL_CRM }}
        run: |
          echo "API_KEY=$API_KEY" > .env
          cat .env  # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–Ω–µ –ø–æ–∫–∞–∂–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ secret)

      # ‚ñ∂Ô∏è 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã Playwright
      - name: Run Playwright tests
        run: npx playwright test --config=playwright.config.js --reporter=list,json
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON-–æ—Ç—á—ë—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

      # üìé 7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á—ë—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: test-results/
          retention-days: 7